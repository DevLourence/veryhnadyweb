<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Portal | Very Handy Solution, Inc.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .card-shadow {
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.04), 0 5px 15px -5px rgba(0, 0, 0, 0.02);
        }

        .sidebar-link.active {
            background: #2563eb;
            color: white;
            box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.3);
        }

        input:focus,
        select:focus,
        textarea:focus {
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 font-sans">

    <nav
        class="glass fixed w-full z-50 border-b border-white/20 px-6 py-4 flex justify-between items-center transition-all duration-300">
        <div class="flex items-center space-x-4">
            <div
                class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-500/20">
                <i class="fa-solid fa-wrench text-lg"></i>
            </div>
            <div>
                <span class="block text-lg font-extrabold uppercase tracking-tighter text-slate-900">Very Handy</span>
                <span
                    class="block text-[10px] font-black uppercase tracking-[0.2em] text-blue-600 -mt-1 leading-none">Solution</span>
            </div>
        </div>
        <div class="flex items-center gap-6">
            <div class="hidden md:flex flex-col items-end">
                <span id="user-greeting" class="font-bold text-slate-900 text-sm">Hello!</span>
                <div id="profile-info" class="text-[10px] text-slate-400 font-bold uppercase tracking-wider"></div>
            </div>
            <button onclick="handleLogout()"
                class="bg-slate-900 text-white px-5 py-2.5 rounded-2xl text-xs font-bold uppercase tracking-widest hover:bg-blue-600 transition-all duration-300 shadow-lg shadow-slate-900/10">Logout</button>
        </div>
    </nav>

    <main class="pt-28 pb-12 px-6 max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">

        <div class="lg:col-span-4">
            <div class="bg-white rounded-[32px] p-8 card-shadow border border-slate-100 sticky top-28">
                <div class="flex items-center gap-3 mb-8">
                    <div class="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600">
                        <i class="fa-solid fa-plus text-lg"></i>
                    </div>
                    <h2 class="text-2xl font-black text-slate-900 tracking-tight">Request Service</h2>
                </div>

                <form id="request-form" class="space-y-5">
                    <div class="space-y-1.5">
                        <label class="block text-[11px] font-extrabold uppercase text-slate-400 tracking-wider">Service
                            Category</label>
                        <select id="service-type" onchange="updateServiceHint()" required
                            class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-4 focus:ring-blue-500/5 focus:bg-white focus:border-blue-500 transition-all text-sm font-semibold">
                            <option value="">Loading services...</option>
                        </select>
                        <p id="service-hint" class="text-[10px] text-blue-600 font-bold px-1"></p>
                    </div>

                    <div class="space-y-1.5">
                        <label class="block text-[11px] font-extrabold uppercase text-slate-400 tracking-wider">Describe
                            the issue</label>
                        <textarea id="service-desc" rows="4" placeholder="Be as specific as possible" required
                            class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-4 focus:ring-blue-500/5 focus:bg-white focus:border-blue-500 transition-all text-sm font-semibold"></textarea>
                    </div>

                    <div class="space-y-1.5">
                        <label class="block text-[11px] font-extrabold uppercase text-slate-400 tracking-wider">Service
                            Branch</label>
                        <select id="service-branch" required
                            class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-4 focus:ring-blue-500/5 focus:bg-white focus:border-blue-500 transition-all text-sm font-semibold">
                            <option value="">Loading branches...</option>
                        </select>
                    </div>

                    <div class="space-y-1.5">
                        <label class="block text-[11px] font-extrabold uppercase text-slate-400 tracking-wider">Specific
                            Location</label>
                        <input id="service-address" type="text" placeholder="Address Details" required
                            class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-4 focus:ring-blue-500/5 focus:bg-white focus:border-blue-500 transition-all text-sm font-semibold" />
                    </div>

                    <div class="space-y-1.5">
                        <label
                            class="block text-[11px] font-extrabold uppercase text-slate-400 tracking-wider">Appointment
                            Time <span class="text-blue-500 font-bold ml-1">(7AM - 7PM, Mon-Sat)</span></label>
                        <input id="service-datetime" type="datetime-local" onchange="validateDateTime(this)" required
                            class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-4 focus:ring-blue-500/5 focus:bg-white focus:border-blue-500 transition-all text-sm font-semibold" />
                    </div>

                    <div class="space-y-1.5">
                        <label class="block text-[11px] font-extrabold uppercase text-slate-400 tracking-wider">Upload
                            Media</label>
                        <input id="service-photo" type="file" multiple class="w-full text-xs">
                    </div>

                    <button type="submit" id="btn-submit"
                        class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:to-blue-600 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-500/20 transition-all transform hover:-translate-y-1 flex items-center justify-center gap-2 uppercase tracking-widest text-[10px]">
                        Submit Request
                    </button>
                </form>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-8">
            <!-- Active Appointments -->
            <div class="bg-white rounded-[32px] p-8 card-shadow border border-slate-100">
                <div class="flex justify-between items-center mb-10">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-600/10 rounded-xl flex items-center justify-center text-blue-600">
                            <i class="fa-solid fa-calendar-check text-lg"></i>
                        </div>
                        <h2 class="text-2xl font-black text-slate-900 tracking-tight">Active Schedule</h2>
                    </div>
                </div>
                <div id="appointments-container" class="space-y-6"></div>
            </div>

            <!-- Service History -->
            <div class="bg-slate-50 rounded-[32px] p-8 border border-slate-100">
                <div class="flex justify-between items-center mb-10">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 bg-slate-200/50 rounded-xl flex items-center justify-center text-slate-400">
                            <i class="fa-solid fa-clock-rotate-left text-lg"></i>
                        </div>
                        <h2 class="text-2xl font-black text-slate-400 tracking-tight">Work History</h2>
                    </div>
                </div>
                <div id="history-container" class="space-y-6 grayscale opacity-60"></div>
            </div>
        </div>
    </main>

    <!-- Review Modal -->
    <div id="review-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeReviewModal()"></div>
        <div class="bg-white relative w-full max-w-lg p-10 rounded-[40px] shadow-2xl border border-slate-100">
            <h2 class="text-2xl font-black text-slate-900 uppercase mb-2 tracking-tight">Share Your Experience</h2>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-8">Feedback helps us maintain
                excellence</p>

            <form id="review-form" class="space-y-6">
                <input type="hidden" id="review-booking-id">
                <div class="space-y-2">
                    <label class="block text-[10px] font-black uppercase text-slate-400 tracking-wider">Reliability &
                        Results</label>
                    <div class="flex gap-3 justify-center text-2xl" id="star-rating">
                        <i class="fa-solid fa-star cursor-pointer text-amber-400 star" data-val="1"></i>
                        <i class="fa-solid fa-star cursor-pointer text-amber-400 star" data-val="2"></i>
                        <i class="fa-solid fa-star cursor-pointer text-amber-400 star" data-val="3"></i>
                        <i class="fa-solid fa-star cursor-pointer text-amber-400 star" data-val="4"></i>
                        <i class="fa-solid fa-star cursor-pointer text-amber-400 star" data-val="5"></i>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="block text-[10px] font-black uppercase text-slate-400 tracking-wider">Your
                        Feedback</label>
                    <textarea id="review-comment" rows="4" placeholder="Tell us how we performed..." required
                        class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-4 focus:ring-blue-500/5 focus:bg-white focus:border-blue-500 transition-all text-sm font-semibold"></textarea>
                </div>

                <div class="space-y-2">
                    <label class="block text-[10px] font-black uppercase text-slate-400 tracking-wider">Project
                        Photos</label>
                    <input id="review-photos" type="file" multiple class="w-full text-xs">
                </div>

                <div class="flex gap-4">
                    <button type="button" onclick="closeReviewModal()"
                        class="flex-1 bg-slate-100 text-slate-600 font-black py-4 rounded-2xl uppercase tracking-widest text-[10px]">Cancel</button>
                    <button type="submit" id="btn-review-submit"
                        class="flex-[2] bg-slate-900 text-white font-black py-4 rounded-2xl uppercase tracking-widest text-[10px] shadow-xl hover:bg-blue-600 transition-all shadow-slate-900/10">
                        Publish Review
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Master UI Modal (Alerts/Confirms) -->
    <div id="ui-modal" class="fixed inset-0 z-[200] hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm p-6">
            <div
                class="bg-white rounded-[40px] shadow-2xl overflow-hidden border border-slate-100 animate-in fade-in zoom-in duration-300">
                <div class="p-8 text-center">
                    <div id="modal-icon"
                        class="w-16 h-16 rounded-3xl flex items-center justify-center text-2xl mx-auto mb-6"></div>
                    <h3 id="ui-modal-title" class="text-xl font-black text-slate-900 uppercase tracking-tighter mb-2">
                    </h3>
                    <p id="ui-modal-msg" class="text-sm font-medium text-slate-500 leading-relaxed mb-8"></p>

                    <div id="modal-actions" class="flex gap-3">
                        <button id="modal-cancel"
                            class="flex-1 bg-slate-100 text-slate-600 font-black py-4 rounded-2xl hover:bg-slate-200 transition-all uppercase text-[10px] tracking-widest hidden">Cancel</button>
                        <button id="modal-confirm"
                            class="flex-1 bg-blue-600 text-white font-black py-4 rounded-2xl hover:bg-slate-900 transition-all uppercase text-[10px] tracking-widest">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Lightbox Modal -->
    <div id="lightbox-modal" class="fixed inset-0 z-[300] hidden">
        <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-xl flex flex-col p-8">
            <div class="flex justify-end p-4">
                <button onclick="closeLightbox()"
                    class="w-12 h-12 rounded-2xl bg-white/10 text-white hover:bg-rose-500 transition-all flex items-center justify-center">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="flex-1 flex items-center justify-center p-4">
                <div id="lightbox-content"
                    class="max-w-4xl w-full h-full flex items-center justify-center overflow-hidden rounded-[40px]">
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://qakgewjfhemqgxxfcdvi.supabase.co'.trim();
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFha2dld2pmaGVtcWd4eGZjZHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODk5MTcsImV4cCI6MjA4NDM2NTkxN30.JIcu_7Veehn370s6e0L60R5gtGKQG7ZmVwnOpKREXlo'.trim();
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;

        async function checkSession() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            currentUser = session.user;
            document.getElementById('user-greeting').innerText = `Hello, ${currentUser.user_metadata.full_name || currentUser.email}`;
            fetchJobs(); fetchProfile(); fetchBranches(); fetchServices();
        }

        let servicesCache = [];
        async function fetchServices() {
            const { data } = await _supabase.from('services').select('*').order('name');
            servicesCache = data || [];
            document.getElementById('service-type').innerHTML = '<option value="">Select Category</option>' + servicesCache.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        }

        function updateServiceHint() {
            const name = document.getElementById('service-type').value;
            const s = servicesCache.find(x => x.name === name);
            document.getElementById('service-hint').innerText = s?.description ? `üí° ${s.description}` : '';
        }

        async function fetchBranches() {
            const { data } = await _supabase.from('branches').select('*').order('name');
            document.getElementById('service-branch').innerHTML = '<option value="">Select Branch</option>' + data.map(b => `<option value="${b.name}">${b.name}</option>`).join('');
        }

        async function fetchJobs() {
            const { data: jobs } = await _supabase
                .from('bookings')
                .select('*, reviews(rating, comment)')
                .eq('client_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (!jobs) return;

            const active = jobs.filter(j => ['pending', 'confirmed', 'in-progress'].includes(j.status));
            const past = jobs.filter(j => ['completed', 'reviewed', 'rejected'].includes(j.status));

            document.getElementById('appointments-container').innerHTML = active.map(j => renderCard(j)).join('') || '<p class="text-slate-400 text-center italic">No active bookings.</p>';
            document.getElementById('history-container').innerHTML = past.map(j => renderCard(j)).join('') || '<p class="text-slate-400 text-center italic">No history.</p>';
        }

        function renderCard(j) {
            const review = j.reviews && j.reviews[0];
            return `
                <div class="p-8 bg-white border border-slate-100 rounded-[28px] card-shadow">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <span class="px-3 py-1 bg-blue-50 text-blue-600 rounded-lg text-[10px] font-black uppercase tracking-widest">${j.status}</span>
                            <h3 class="text-xl font-black mt-2 uppercase">${j.service_type}</h3>
                            ${review ? `
                                <div class="flex gap-1 text-amber-400 mt-2 text-xs">
                                    ${'‚òÖ'.repeat(review.rating)}${'‚òÜ'.repeat(5 - review.rating)}
                                </div>
                            ` : ''}
                        </div>
                        <span class="text-xs font-bold text-slate-400">${new Date(j.booking_date).toLocaleDateString()}</span>
                    </div>
                    <p class="text-sm text-slate-500 mb-6 leading-relaxed">
                        ${review ? `<span class="block italic text-slate-400 mb-2">"${review.comment}"</span>` : ''}
                        ${j.description}
                    </p>
                    <div class="flex justify-between items-center text-[10px] font-black text-slate-400 uppercase tracking-widest border-t pt-6 border-slate-50">
                        <div class="flex gap-4">
                            <span><i class="fa-solid fa-location-dot text-blue-600 mr-2"></i>${j.branch_name}</span>
                            <span><i class="fa-solid fa-clock text-blue-600 mr-2"></i>${new Date(j.booking_date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                        ${j.status === 'completed' && !review ? `
                            <button onclick="openReviewModal('${j.id}')" class="text-blue-600 hover:text-indigo-600 transition-colors flex items-center gap-2">
                                <i class="fa-solid fa-star"></i> Leave Review
                            </button>
                        ` : ''}
                        ${review ? `
                            <span class="text-emerald-500 flex items-center gap-1">
                                <i class="fa-solid fa-circle-check"></i> Reviewed
                            </span>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Instant Datetime Validation
        function validateDateTime(input) {
            const val = input.value;
            if (!val) {
                input.classList.remove('border-emerald-500', 'border-rose-500');
                input.classList.add('border-slate-100');
                return;
            }

            const bDate = new Date(val);
            const day = bDate.getDay();
            const hour = bDate.getHours();

            let isValid = true;
            let errorMsg = "";

            if (day === 0) {
                isValid = false;
                errorMsg = "‚ùå We are closed on Sundays. Please select Mon-Sat.";
            } else if (hour < 7 || hour >= 19) {
                isValid = false;
                errorMsg = "‚ùå Appointments are only available between 7:00 AM and 7:00 PM.";
            }

            if (!isValid) {
                input.classList.remove('border-slate-100', 'border-emerald-500');
                input.classList.add('border-rose-500');

                showNiceModal({
                    title: "Invalid Timing",
                    message: errorMsg,
                    type: "warning"
                });

                input.value = "";
                setTimeout(() => {
                    input.classList.remove('border-rose-500');
                    input.classList.add('border-slate-100');
                }, 2000);
            } else {
                input.classList.remove('border-slate-100', 'border-rose-500');
                input.classList.add('border-emerald-500');
            }
        }

        async function fetchProfile() {
            const { data } = await _supabase.from('profiles').select('*').eq('id', currentUser.id).single();
            if (data) document.getElementById('profile-info').innerText = `Location: ${data.address || 'Unknown'} | Mobile: ${data.mobile || 'N/A'}`;
        }

        // Helper: Strict 1-minute video limit
        function getVideoDuration(file) {
            return new Promise((resolve) => {
                if (!file.type.includes('video')) return resolve(0);
                const video = document.createElement('video');
                video.preload = 'metadata';
                video.onloadedmetadata = () => {
                    window.URL.revokeObjectURL(video.src);
                    resolve(video.duration);
                };
                video.src = URL.createObjectURL(file);
            });
        }

        document.getElementById('request-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            const files = document.getElementById('service-photo').files;

            btn.disabled = true;
            btn.innerText = "VALIDATING & UPLOADING...";

            try {
                // Time & Day Validation (7 AM - 7 PM, Monday to Saturday)
                const bookingInp = document.getElementById('service-datetime').value;
                if (!bookingInp) throw new Error("Please select an appointment time.");

                const bDate = new Date(bookingInp);
                const day = bDate.getDay(); // 0 = Sunday, 1 = Monday...
                const hour = bDate.getHours();

                if (day === 0) {
                    throw new Error("We are closed on Sundays. Please select a day from Monday to Saturday.");
                }
                if (hour < 7 || hour >= 19) {
                    throw new Error("Appointments are only available between 7:00 AM and 7:00 PM.");
                }

                let uploadedUrls = [];
                if (files.length > 0) {
                    for (let file of files) {
                        // Check Duration
                        if (file.type.includes('video')) {
                            const duration = await getVideoDuration(file);
                            if (duration > 61) { // 1 second buffer
                                throw new Error(`Video "${file.name}" exceeds the 1-minute limit (${Math.round(duration)}s).`);
                            }
                        }

                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('upload_preset', 'veryhandy_unsigned');

                        const res = await fetch(`https://api.cloudinary.com/v1_1/dglvvvleh/${file.type.includes('video') ? 'video' : 'image'}/upload`, {
                            method: 'POST',
                            body: formData
                        });
                        const data = await res.json();
                        if (data.secure_url) {
                            uploadedUrls.push(data.secure_url);
                        } else if (data.error) {
                            throw new Error(`Cloudinary Error: ${data.error.message}`);
                        }
                    }
                }

                const { data: newBooking, error } = await _supabase.from('bookings').insert([{
                    client_id: currentUser.id,
                    service_type: document.getElementById('service-type').value,
                    description: document.getElementById('service-desc').value,
                    branch_name: document.getElementById('service-branch').value,
                    address: document.getElementById('service-address').value,
                    booking_date: document.getElementById('service-datetime').value,
                    photo_url: JSON.stringify(uploadedUrls),
                    status: 'pending'
                }]).select().single();

                if (error) throw error;

                // Notify Admin (Non-blocking)
                // Notify Admin (Non-blocking)
                const { error: notifyErr } = await _supabase.functions.invoke('send-booking-notification', {
                    body: { bookingId: newBooking.id, type: 'new_booking' }
                });
                if (notifyErr) console.error("Admin notification failed:", notifyErr);
                showNiceModal({
                    title: "Request Sent",
                    message: "‚úÖ Request Transmitted: Our team will review your requirement shortly.",
                    type: "success"
                });
                document.getElementById('request-form').reset();
                fetchJobs();
            } catch (err) {
                console.error(err);
                showNiceModal({
                    title: "Submission Failed",
                    message: err.message,
                    type: "danger"
                });
            } finally {
                btn.disabled = false;
                btn.innerText = "Submit Request";
            }
        });

        async function handleLogout() {
            const confirmed = await showNiceModal({
                title: "Sign Out",
                message: "Are you sure you want to exit your dashboard?",
                type: "warning",
                confirmText: "Sign Out",
                cancelText: "Stay"
            });
            if (!confirmed) return;
            await _supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        // --- REVIEW SYSTEM ---
        let currentRating = 5;
        function openReviewModal(bookingId) {
            document.getElementById('review-booking-id').value = bookingId;
            document.getElementById('review-modal').classList.remove('hidden');
            setRating(5);
        }

        function closeReviewModal() {
            document.getElementById('review-modal').classList.add('hidden');
            document.getElementById('review-form').reset();
        }

        function setRating(val) {
            currentRating = val;
            document.querySelectorAll('.star').forEach((s, idx) => {
                s.classList.toggle('text-amber-400', idx < val);
                s.classList.toggle('text-slate-200', idx >= val);
            });
        }

        document.querySelectorAll('.star').forEach(s => {
            s.onclick = () => setRating(parseInt(s.dataset.val));
        });

        document.getElementById('review-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-review-submit');
            const bookingId = document.getElementById('review-booking-id').value;
            const comment = document.getElementById('review-comment').value;
            const files = document.getElementById('review-photos').files;

            btn.disabled = true; btn.innerText = "UPLOADING & PUBLISHING...";

            try {
                let uploadedUrls = [];
                if (files.length > 0) {
                    for (let file of files) {
                        // Check Duration
                        if (file.type.includes('video')) {
                            const duration = await getVideoDuration(file);
                            if (duration > 61) { // 1 second buffer
                                throw new Error(`Video "${file.name}" exceeds the 1-minute limit (${Math.round(duration)}s).`);
                            }
                        }

                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('upload_preset', 'veryhandy_unsigned');

                        const resourceType = file.type.includes('video') ? 'video' : 'image';
                        const res = await fetch(`https://api.cloudinary.com/v1_1/dglvvvleh/${resourceType}/upload`, {
                            method: 'POST',
                            body: formData
                        });
                        const data = await res.json();
                        if (data.secure_url) {
                            uploadedUrls.push(data.secure_url);
                        } else if (data.error) {
                            throw new Error(`Cloudinary Error: ${data.error.message}`);
                        }
                    }
                }

                const { error: reviewError } = await _supabase.from('reviews').insert([{
                    client_id: currentUser.id,
                    booking_id: bookingId,
                    rating: currentRating,
                    comment: comment,
                    photo_urls: JSON.stringify(uploadedUrls),
                    is_public: false // Admin must approve to show on landing page
                }]);

                if (reviewError) throw reviewError;

                // Update booking status to 'reviewed'
                await _supabase.from('bookings').update({ status: 'reviewed' }).eq('id', bookingId);

                // Notify Admin about the review
                const { error: notifyErr } = await _supabase.functions.invoke('send-booking-notification', {
                    body: {
                        bookingId: bookingId,
                        type: 'new_review',
                        rating: currentRating,
                        comment: comment
                    }
                });
                if (notifyErr) {
                    console.warn("Review notification failed:", notifyErr);
                    alert("Notification Warning: Review saved, but email alert failed to send. Check Supabase Logs.");
                }


                showNiceModal({
                    title: "Review Published",
                    message: "‚úÖ Review Published: Thank you for your feedback!",
                    type: "success"
                });
                closeReviewModal();
                fetchJobs();
            } catch (err) {
                console.error(err);
                showNiceModal({
                    title: "Feedback Error",
                    message: "Failed to submit review: " + err.message,
                    type: "danger"
                });
            } finally {
                btn.disabled = false; btn.innerText = "Publish Review";
            }
        });

        // --- Session Timeout (AFK Handler) ---
        function initSessionTimeout() {
            let timeout;
            const TIMEOUT_DURATION = 3600000; // 1 Hour

            async function logoutUser() {
                alert("Session Expired: You have been inactive for 1 hour. Logging out for security.");
                // We use a direct signout call here or re-use handleLogout but avoid the confirmation dialog
                await _supabase.auth.signOut();
                window.location.href = 'index.html';
            }

            function resetTimer() {
                clearTimeout(timeout);
                timeout = setTimeout(logoutUser, TIMEOUT_DURATION);
            }

            window.onload = resetTimer;
            document.onmousemove = resetTimer;
            document.onkeypress = resetTimer;
            document.onclick = resetTimer;
            document.onscroll = resetTimer;
        }

        initSessionTimeout();
        checkSession();

        // --- Premium Modal System ---
        function showNiceModal({ title, message, type = 'info', confirmText = 'OK', cancelText = null }) {
            return new Promise((resolve) => {
                const modal = document.getElementById('ui-modal');
                const titleEl = document.getElementById('ui-modal-title');
                const msgEl = document.getElementById('ui-modal-msg');
                const iconEl = document.getElementById('modal-icon');
                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');

                titleEl.innerText = title;
                msgEl.innerText = message;
                confirmBtn.innerText = confirmText;

                // Type Styling
                iconEl.className = "w-16 h-16 rounded-3xl flex items-center justify-center text-2xl mx-auto mb-6 ";
                if (type === 'danger') {
                    iconEl.classList.add('bg-rose-50', 'text-rose-500');
                    iconEl.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i>';
                    confirmBtn.className = "flex-1 bg-rose-500 text-white font-black py-4 rounded-2xl hover:bg-rose-600 transition-all uppercase text-[10px] tracking-widest";
                } else if (type === 'success') {
                    iconEl.classList.add('bg-emerald-50', 'text-emerald-500');
                    iconEl.innerHTML = '<i class="fa-solid fa-circle-check"></i>';
                    confirmBtn.className = "flex-1 bg-emerald-500 text-white font-black py-4 rounded-2xl hover:bg-emerald-600 transition-all uppercase text-[10px] tracking-widest";
                } else if (type === 'warning') {
                    iconEl.classList.add('bg-amber-50', 'text-amber-500');
                    iconEl.innerHTML = '<i class="fa-solid fa-circle-exclamation"></i>';
                    confirmBtn.className = "flex-1 bg-amber-500 text-white font-black py-4 rounded-2xl hover:bg-amber-600 transition-all uppercase text-[10px] tracking-widest";
                } else {
                    iconEl.classList.add('bg-blue-50', 'text-blue-500');
                    iconEl.innerHTML = '<i class="fa-solid fa-circle-info"></i>';
                    confirmBtn.className = "flex-1 bg-blue-600 text-white font-black py-4 rounded-2xl hover:bg-blue-700 transition-all uppercase text-[10px] tracking-widest";
                }

                if (cancelText) {
                    cancelBtn.innerText = cancelText;
                    cancelBtn.classList.remove('hidden');
                } else {
                    cancelBtn.classList.add('hidden');
                }

                modal.classList.remove('hidden');

                confirmBtn.onclick = () => { modal.classList.add('hidden'); resolve(true); };
                cancelBtn.onclick = () => { modal.classList.add('hidden'); resolve(false); };
            });
        }

        function openLightbox(src) {
            const modal = document.getElementById('lightbox-modal');
            const container = document.getElementById('lightbox-content');
            const isVideo = src.toLowerCase().match(/\.(mp4|mov|webm|ogg|m4v)$/) || src.includes('/video/upload/');

            container.innerHTML = isVideo
                ? `<video src="${src}" controls autoplay class="max-w-full max-h-full rounded-2xl shadow-2xl"></video>`
                : `<img src="${src}" class="max-w-full max-h-full object-contain rounded-2xl shadow-2xl transition-all">`;

            modal.classList.remove('hidden');
        }

        function closeLightbox() {
            document.getElementById('lightbox-modal').classList.add('hidden');
            document.getElementById('lightbox-content').innerHTML = ''; // Stop video
        }
    </script>
</body>

</html>