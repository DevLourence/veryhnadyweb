<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | VeryHandy Solution, Inc.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- FullCalendar -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .sidebar-item.active {
            background: #2563eb;
            color: white;
            box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.3);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .card-shadow {
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.04), 0 5px 15px -5px rgba(0, 0, 0, 0.02);
        }

        /* Calendar Styling */
        .fc {
            background: white;
            border-radius: 24px;
            padding: 20px;
            border: none;
        }

        .fc-toolbar-title {
            font-weight: 800 !important;
            text-transform: uppercase;
            font-size: 1.25rem !important;
        }

        .fc-button-primary {
            background: #2563eb !important;
            border: none !important;
            border-radius: 12px !important;
            text-transform: uppercase;
            font-weight: 800;
            font-size: 10px !important;
            letter-spacing: 1px;
        }

        .fc-event {
            border-radius: 8px !important;
            padding: 4px 8px !important;
            border: none !important;
            cursor: pointer;
        }

        .fc-daygrid-day:hover {
            background: #f8fafc;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen">

    <div class="flex min-h-screen bg-slate-50">
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-900 text-slate-400 p-6 flex flex-col fixed h-full z-50">
            <div class="flex items-center gap-3 mb-12">
                <div
                    class="w-10 h-10 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-500/20">
                    <i class="fa-solid fa-wrench"></i>
                </div>
                <div>
                    <span
                        class="block text-white font-black uppercase tracking-tighter text-lg leading-none">VeryHandy</span>
                    <span
                        class="block text-[8px] font-black uppercase tracking-[0.2em] text-blue-500 mt-1 leading-none">Admin
                        Panel</span>
                </div>
            </div>

            <nav class="flex-1 space-y-2">
                <button onclick="switchTab('clients')" id="btn-clients"
                    class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all duration-300 font-bold text-sm">
                    <i class="fa-solid fa-users w-5"></i>
                    <span>Clients</span>
                </button>
                <button onclick="switchTab('schedule')" id="btn-schedule"
                    class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all duration-300 font-bold text-sm">
                    <i class="fa-solid fa-calendar-days w-5"></i>
                    <span>Schedule</span>
                </button>
                <button onclick="switchTab('bookings')" id="btn-bookings"
                    class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all duration-300 font-bold text-sm">
                    <i class="fa-solid fa-calendar-check w-5"></i>
                    <span>Bookings</span>
                </button>
                <button onclick="switchTab('reviews')" id="btn-reviews"
                    class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all duration-300 font-bold text-sm">
                    <i class="fa-solid fa-star w-5"></i>
                    <span>Reviews</span>
                </button>
                <button onclick="switchTab('branches')" id="btn-branches"
                    class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all duration-300 font-bold text-sm">
                    <i class="fa-solid fa-location-dot w-5"></i>
                    <span>Branches</span>
                </button>
                <button onclick="switchTab('services')" id="btn-services"
                    class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all duration-300 font-bold text-sm">
                    <i class="fa-solid fa-briefcase w-5"></i>
                    <span>Services</span>
                </button>
                <div class="pt-4 mt-4 border-t border-slate-800/50">
                    <button onclick="switchTab('media')" id="btn-media"
                        class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all duration-300 font-bold text-sm">
                        <i class="fa-solid fa-photo-film w-5"></i>
                        <span>Media Vault</span>
                    </button>
                </div>
            </nav>

            <button onclick="handleLogout()"
                class="mt-auto flex items-center gap-3 px-4 py-3 rounded-2xl text-rose-400 hover:bg-rose-500/10 transition-all font-black uppercase text-[10px] tracking-widest">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span>Sign Out</span>
            </button>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 ml-64 p-8 min-h-screen">
            <!-- Header -->
            <header class="flex justify-between items-center mb-12">
                <div>
                    <h1 id="page-title" class="text-3xl font-black text-slate-900 tracking-tight uppercase">Admin
                        Dashboard</h1>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">VeryHandy Solution, Inc.
                    </p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <span id="admin-name"
                            class="block text-sm font-black text-slate-900 uppercase">Administrator</span>
                        <span class="block text-[10px] font-bold text-emerald-500 uppercase tracking-widest">System
                            Active</span>
                    </div>
                    <div
                        class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center border border-slate-200 shadow-sm">
                        <i class="fa-solid fa-user-shield text-blue-600"></i>
                    </div>
                </div>
            </header>

            <section id="clients-section" class="tab-content">
                <div class="bg-white rounded-[32px] p-8 card-shadow border border-slate-100 overflow-hidden">
                    <table class="w-full text-left">
                        <thead
                            class="bg-slate-50 text-[10px] font-black uppercase tracking-widest text-slate-400 border-b border-slate-100">
                            <tr>
                                <th class="p-6">Full Name</th>
                                <th class="p-6">Contact Info</th>
                                <th class="p-6">Role</th>
                                <th class="p-6 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="client-table-body" class="text-sm divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </section>

            <section id="schedule-section" class="tab-content hidden">
                <div class="bg-white rounded-[32px] p-8 card-shadow border border-slate-100 min-h-[600px]">
                    <div id="calendar"></div>
                </div>
            </section>

            <section id="bookings-section" class="tab-content hidden">
                <div class="bg-white rounded-[32px] p-8 card-shadow border border-slate-100 overflow-hidden">
                    <table class="w-full text-left">
                        <thead
                            class="bg-slate-50 text-[10px] font-black uppercase tracking-widest text-slate-400 border-b border-slate-100">
                            <tr>
                                <th class="p-6">Client & Service</th>
                                <th class="p-6">Location & Time</th>
                                <th class="p-6">Media</th>
                                <th class="p-6">Status</th>
                                <th class="p-6 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="booking-table-body" class="text-sm divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </section>

            <section id="reviews-section" class="tab-content hidden">
                <div class="bg-white rounded-[32px] p-8 card-shadow border border-slate-100 overflow-hidden">
                    <table class="w-full text-left">
                        <thead
                            class="bg-slate-50 text-[10px] font-black uppercase tracking-widest text-slate-400 border-b border-slate-100">
                            <tr>
                                <th class="p-6">Client</th>
                                <th class="p-6">Feedback</th>
                                <th class="p-6">Media</th>
                                <th class="p-6">Publicity</th>
                                <th class="p-6 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="review-table-body" class="text-sm divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </section>

            <section id="branches-section" class="tab-content hidden">
                <!-- Add Branch Form -->
                <div class="bg-white rounded-[32px] p-8 card-shadow border border-slate-100 mb-8">
                    <h2 class="text-xl font-black text-slate-900 mb-6 uppercase tracking-tight">Add New Branch</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <input id="branch-name" placeholder="Branch Name"
                            class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-100 outline-none focus:ring-4 focus:ring-blue-500/5 focus:bg-white focus:border-blue-500 transition-all font-bold text-sm">
                        <input id="branch-address" placeholder="Branch Address"
                            class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-100 outline-none focus:ring-4 focus:ring-blue-500/5 focus:bg-white focus:border-blue-500 transition-all font-bold text-sm">
                        <button onclick="addBranch()"
                            class="bg-blue-600 hover:bg-slate-900 text-white font-black py-4 px-8 rounded-2xl shadow-xl shadow-blue-500/20 transition-all uppercase text-[10px] tracking-[0.2em] flex items-center justify-center gap-2">
                            <i class="fa-solid fa-plus"></i> Add Branch
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-[32px] p-8 card-shadow border border-slate-100 overflow-hidden">
                    <table class="w-full text-left">
                        <thead
                            class="bg-slate-50 text-[10px] font-black uppercase tracking-widest text-slate-400 border-b border-slate-100">
                            <tr>
                                <th class="p-6">Branch Name</th>
                                <th class="p-6">Address</th>
                                <th class="p-6 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="branch-table-body" class="text-sm divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </section>

            <section id="services-section" class="tab-content hidden">
                <div class="bg-white rounded-[32px] p-8 card-shadow border border-slate-100 mb-8">
                    <h2 class="text-xl font-black text-slate-900 mb-6 uppercase tracking-tight">Add New Service</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <input id="service-name" placeholder="Service Name (e.g. Plumbing)"
                            class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-100 outline-none focus:ring-4 focus:ring-blue-500/5 focus:bg-white focus:border-blue-500 transition-all font-bold text-sm">
                        <input id="service-desc" placeholder="Details (e.g. Basic repair)"
                            class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-100 outline-none focus:ring-4 focus:ring-blue-500/5 focus:bg-white focus:border-blue-500 transition-all font-bold text-sm">
                        <input id="service-fee" placeholder="Fee (e.g. ₱500)"
                            class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-100 outline-none focus:ring-4 focus:ring-blue-500/5 focus:bg-white focus:border-blue-500 transition-all font-bold text-sm">
                        <button onclick="addService()"
                            class="bg-indigo-600 hover:bg-slate-900 text-white font-black py-4 px-8 rounded-2xl shadow-xl shadow-indigo-500/20 transition-all uppercase text-[10px] tracking-[0.2em] flex items-center justify-center gap-2">
                            <i class="fa-solid fa-plus"></i> Add Service
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-[32px] p-8 card-shadow border border-slate-100 overflow-hidden">
                    <table class="w-full text-left">
                        <thead
                            class="bg-slate-50 text-[10px] font-black uppercase tracking-widest text-slate-400 border-b border-slate-100">
                            <tr>
                                <th class="p-6">Service Name</th>
                                <th class="p-6">Description</th>
                                <th class="p-6">Service Fee</th>
                                <th class="p-6 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="service-table-body" class="text-sm divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </section>

            <section id="media-section" class="tab-content hidden">
                <div class="mb-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                    <div>
                        <h2 class="text-3xl font-black text-slate-900 uppercase tracking-tighter">Media Storage Manager
                        </h2>
                        <div class="flex items-center gap-3 mt-1">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em]">Review, Maintain,
                                or Purge Project Assets</p>
                            <div id="cleanup-alert"
                                class="hidden flex items-center gap-2 bg-rose-50 text-rose-500 px-3 py-1 rounded-full animate-pulse">
                                <i class="fa-solid fa-broom text-[8px]"></i>
                                <span id="cleanup-count" class="text-[8px] font-black uppercase tracking-widest">0
                                    Cleanup Candidates</span>
                                <button onclick="purgeOldMedia()"
                                    class="text-[8px] font-black uppercase tracking-widest underline decoration-2 underline-offset-2 hover:text-rose-700">Purge
                                    Now</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-6">
                        <div class="hidden lg:block text-right">
                            <div class="flex items-center gap-3 mb-2 justify-end">
                                <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">System
                                    Health</span>
                                <span id="storage-percent"
                                    class="text-[10px] font-black text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full">0%</span>
                            </div>
                            <div class="w-48 h-2 bg-slate-100 rounded-full overflow-hidden border border-slate-50">
                                <div id="storage-bar" class="h-full bg-blue-600 transition-all duration-1000"
                                    style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <button onclick="fetchAllMedia()"
                                class="w-12 h-12 bg-white text-slate-600 hover:bg-slate-900 hover:text-white rounded-2xl flex items-center justify-center transition-all shadow-xl shadow-slate-200/20"
                                title="Refresh Catalog">
                                <i class="fa-solid fa-rotate w-5"></i>
                            </button>
                            <div
                                class="bg-blue-600 px-8 py-5 rounded-[32px] text-white shadow-2xl shadow-blue-500/30 flex items-center gap-6">
                                <div class="text-left">
                                    <p class="text-[8px] font-black text-blue-200 uppercase tracking-[0.2em] mb-1">
                                        Storage
                                        Index
                                    </p>
                                    <p id="media-count" class="text-lg font-black tracking-tighter">0 Assets Discovered
                                    </p>
                                </div>
                                <div
                                    class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-md">
                                    <i class="fa-solid fa-database text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6" id="media-grid">
                    <!-- Media items will be injected here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Calendar Event Modal -->
    <div id="event-modal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeEventModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-6">
            <div
                class="bg-white rounded-[40px] shadow-2xl overflow-hidden border border-slate-100 animate-in fade-in zoom-in duration-300">
                <div class="p-8">
                    <div class="flex justify-between items-start mb-6">
                        <div id="modal-status-badge"
                            class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest"></div>
                        <button onclick="closeEventModal()"
                            class="text-slate-300 hover:text-slate-600 transition-colors">
                            <i class="fa-solid fa-circle-xmark text-xl"></i>
                        </button>
                    </div>

                    <h2 id="modal-project"
                        class="text-2xl font-black text-slate-900 leading-tight mb-2 uppercase tracking-tighter"></h2>
                    <p id="modal-client" class="text-blue-600 font-bold text-sm mb-8"></p>

                    <div class="space-y-4">
                        <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-2xl">
                            <div
                                class="w-10 h-10 bg-white rounded-xl shadow-sm flex items-center justify-center text-blue-500">
                                <i class="fa-regular fa-clock"></i>
                            </div>
                            <div>
                                <span
                                    class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">Scheduled
                                    Time</span>
                                <span id="modal-time" class="block text-sm font-bold text-slate-700"></span>
                            </div>
                        </div>

                        <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-2xl">
                            <div
                                class="w-10 h-10 bg-white rounded-xl shadow-sm flex items-center justify-center text-emerald-500">
                                <i class="fa-solid fa-location-dot"></i>
                            </div>
                            <div>
                                <span
                                    class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">Service
                                    Branch</span>
                                <span id="modal-branch" class="block text-sm font-bold text-slate-700"></span>
                            </div>
                        </div>
                    </div>

                    <button onclick="closeEventModal()"
                        class="w-full mt-8 bg-slate-900 text-white font-black py-4 rounded-2xl hover:bg-blue-600 transition-all uppercase text-[10px] tracking-[0.2em] shadow-xl shadow-slate-900/10">
                        Dismiss
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Master UI Modal (Alerts/Confirms) -->
    <div id="ui-modal" class="fixed inset-0 z-[200] hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm p-6">
            <div
                class="bg-white rounded-[40px] shadow-2xl overflow-hidden border border-slate-100 animate-in fade-in zoom-in duration-300">
                <div class="p-8 text-center">
                    <div id="modal-icon"
                        class="w-16 h-16 rounded-3xl flex items-center justify-center text-2xl mx-auto mb-6"></div>
                    <h3 id="ui-modal-title" class="text-xl font-black text-slate-900 uppercase tracking-tighter mb-2">
                    </h3>
                    <p id="ui-modal-msg" class="text-sm font-medium text-slate-500 leading-relaxed mb-8"></p>

                    <div id="modal-actions" class="flex gap-3">
                        <button id="modal-cancel"
                            class="flex-1 bg-slate-100 text-slate-600 font-black py-4 rounded-2xl hover:bg-slate-200 transition-all uppercase text-[10px] tracking-widest hidden">Cancel</button>
                        <button id="modal-confirm"
                            class="flex-1 bg-blue-600 text-white font-black py-4 rounded-2xl hover:bg-slate-900 transition-all uppercase text-[10px] tracking-widest">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Lightbox Modal -->
    <div id="lightbox-modal" class="fixed inset-0 z-[300] hidden">
        <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-xl flex flex-col p-8">
            <div class="flex justify-end p-4">
                <button onclick="closeLightbox()"
                    class="w-12 h-12 rounded-2xl bg-white/10 text-white hover:bg-rose-500 transition-all flex items-center justify-center">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="flex-1 flex items-center justify-center p-4">
                <div id="lightbox-content"
                    class="max-w-4xl w-full h-full flex items-center justify-center overflow-hidden rounded-[40px]">
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://qakgewjfhemqgxxfcdvi.supabase.co'.trim();
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFha2dld2pmaGVtcWd4eGZjZHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODk5MTcsImV4cCI6MjA4NDM2NTkxN30.JIcu_7Veehn370s6e0L60R5gtGKQG7ZmVwnOpKREXlo'.trim();
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function checkSession() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) {
                window.location.href = 'index.html';
                return;
            }

            const { data: profile, error } = await _supabase
                .from('profiles')
                .select('role')
                .eq('id', session.user.id)
                .maybeSingle();

            if (error || !profile || profile.role !== 'admin') {
                alert("Restricted: Admin Credentials Required.");
                window.location.href = 'client_dashboard.html';
            }
        }
        checkSession();

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tab + '-section').classList.remove('hidden');
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            document.getElementById('btn-' + tab).classList.add('active');

            const titles = {
                'clients': 'Client Network',
                'schedule': 'Master Schedule',
                'bookings': 'Operations Hub',
                'reviews': 'Quality Assurance',
                'branches': 'Regional Nodes',
                'services': 'Service Inventory'
            };
            document.getElementById('page-title').innerText = titles[tab] || 'Admin Dashboard';

            if (tab === 'clients') fetchClients();
            else if (tab === 'schedule') initCalendar();
            else if (tab === 'bookings') fetchBookings();
            else if (tab === 'reviews') fetchReviews();
            else if (tab === 'branches') fetchBranches();
            else if (tab === 'services') fetchServices();
        }

        let calendar = null;
        async function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            if (calendar) calendar.destroy();

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: async function (info, successCallback, failureCallback) {
                    const { data, error } = await _supabase
                        .from('bookings')
                        .select('*, profiles:client_id(full_name)')
                        .in('status', ['confirmed', 'completed', 'reviewed']);

                    if (error) {
                        failureCallback(error);
                        return;
                    }

                    const events = data.map(b => ({
                        title: `${b.profiles?.full_name}: ${b.service_type}`,
                        start: b.booking_date,
                        backgroundColor:
                            b.status === 'confirmed' ? '#10b981' : // Emerald
                                b.status === 'completed' ? '#2563eb' : // Blue
                                    '#4f46e5', // Indigo (Reviewed)
                        extendedProps: { ...b }
                    }));
                    successCallback(events);
                },
                eventClick: function (info) {
                    const b = info.event.extendedProps;
                    showEventModal(b);
                }
            });
            calendar.render();
        }

        function showEventModal(b) {
            const modal = document.getElementById('event-modal');
            const project = document.getElementById('modal-project');
            const client = document.getElementById('modal-client');
            const time = document.getElementById('modal-time');
            const branch = document.getElementById('modal-branch');
            const badge = document.getElementById('modal-status-badge');

            project.innerText = b.service_type;
            client.innerText = `Client: ${b.profiles?.full_name || 'N/A'}`;
            time.innerText = new Date(b.booking_date).toLocaleString([], { dateStyle: 'long', timeStyle: 'short' });
            branch.innerText = b.branch_name || 'Main Office';

            badge.innerText = b.status;
            if (b.status === 'confirmed') {
                badge.className = "px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-emerald-100 text-emerald-700";
            } else if (b.status === 'completed') {
                badge.className = "px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-blue-100 text-blue-700";
            } else {
                badge.className = "px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-indigo-100 text-indigo-700";
            }

            modal.classList.remove('hidden');
        }

        function closeEventModal() {
            document.getElementById('event-modal').classList.add('hidden');
        }

        async function fetchClients() {
            const tbody = document.getElementById('client-table-body');
            const { data, error } = await _supabase.from('profiles').select('*');

            if (error) {
                console.error("Fetch Clients Error:", error);
                tbody.innerHTML = `<tr><td colspan="4" class="p-12 text-center text-rose-500 font-bold uppercase tracking-widest text-[10px]">Error loading clients: ${error.message}</td></tr>`;
                return;
            }

            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="p-12 text-center text-slate-400 font-bold uppercase tracking-widest text-[10px]">No registered clients found.</td></tr>`;
                return;
            }

            const { data: { session } } = await _supabase.auth.getSession();
            const currentUserId = session?.user?.id;

            tbody.innerHTML = data.map(u => `
                <tr class="hover:bg-slate-50/50 transition-colors">
                    <td class="p-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center font-black text-slate-400 text-xs">
                                ${u.full_name ? u.full_name.charAt(0) : '?'}
                            </div>
                            <div>
                                <div class="font-bold text-slate-900">${u.full_name || 'No Name'}</div>
                                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">ID: ${u.id.substring(0, 8)}</div>
                            </div>
                        </div>
                    </td>
                    <td class="p-6">
                        <div class="flex flex-col gap-1">
                            <div class="text-sm font-semibold text-slate-600 flex items-center gap-2">
                                <i class="fa-solid fa-phone text-[10px]"></i> ${u.mobile || '-'}
                            </div>
                            <div class="text-[11px] text-slate-400 flex items-center gap-2">
                                <i class="fa-solid fa-location-dot text-[10px]"></i> ${u.address || '-'}
                            </div>
                        </div>
                    </td>
                    <td class="p-6">
                        <span class="px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest ${u.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">
                            ${u.role}
                        </span>
                    </td>
                    <td class="p-6 text-right">
                        ${u.id !== currentUserId ? `
                            <button onclick="deleteClient('${u.id}', '${u.full_name}')" class="w-8 h-8 rounded-lg bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white transition-all flex items-center justify-center ml-auto">
                                <i class="fa-solid fa-trash-can text-xs"></i>
                            </button>
                        ` : '<span class="text-slate-300 text-[10px] font-black uppercase italic">Master Account</span>'}
                    </td>
                </tr>
            `).join('');
        }

        async function deleteClient(userId, userName) {
            const confirmed = await showNiceModal({
                title: "Delete Account",
                message: `Are you sure you want to permanently delete "${userName}"? This action cannot be undone.`,
                type: "danger",
                confirmText: "Delete Account",
                cancelText: "Cancel"
            });
            if (!confirmed) return;

            const { error } = await _supabase.functions.invoke('delete-user', { body: { userId } });
            if (error) {
                showNiceModal({
                    title: "Deletion Failed",
                    message: error.message,
                    type: "danger"
                });
            } else {
                showNiceModal({
                    title: "Success",
                    message: "Account has been permanently purged.",
                    type: "success"
                });
                fetchClients();
            }
        }

        async function fetchBookings() {
            const tbody = document.getElementById('booking-table-body');
            const { data, error } = await _supabase
                .from('bookings')
                .select('*, profiles:client_id (full_name, email), reviews(rating)')
                .order('created_at', { ascending: false });

            if (error) {
                console.error("Fetch Bookings Error:", error);
                tbody.innerHTML = `<tr><td colspan="5" class="p-12 text-center text-rose-500 font-bold uppercase tracking-widest text-[10px]">Error loading operations: ${error.message}</td></tr>`;
                return;
            }

            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-12 text-center text-slate-400 font-bold uppercase tracking-widest text-[10px]">No active operations recorded.</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(b => `
                <tr class="hover:bg-slate-50/50 transition-colors">
                    <td class="p-6">
                        <div class="font-bold text-slate-900">${b.profiles?.full_name || 'Deleted Client'}</div>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span class="text-[11px] font-black text-blue-600 uppercase tracking-tight">${b.service_type}</span>
                            ${b.reviews && b.reviews[0] ? `
                                <div class="flex gap-0.5 text-amber-400 text-[8px]">
                                    ${'★'.repeat(b.reviews[0].rating)}${'☆'.repeat(5 - b.reviews[0].rating)}
                                </div>
                            ` : ''}
                        </div>
                    </td>
                    <td class="p-6 text-xs text-slate-500">
                        <div class="flex items-center gap-1.5 mb-1 font-black text-slate-400 uppercase tracking-tighter">
                            <i class="fa-solid fa-location-dot"></i> ${b.branch_name || 'Global'}
                        </div>
                        <div>${b.address || '-'}</div>
                        <div class="mt-1 font-bold text-slate-900">${new Date(b.booking_date).toLocaleString()}</div>
                    </td>
                    <td class="p-6">
                <div class="flex gap-1">
                    ${(function () {
                    try {
                        const urls = JSON.parse(b.photo_url || '[]');
                        return urls.map(url => {
                            const isVideo = url.toLowerCase().match(/\.(mp4|mov|webm|ogg|m4v)$/) || url.includes('/video/upload/');
                            if (isVideo) {
                                return `<div class="relative w-8 h-8 rounded-lg overflow-hidden border border-slate-200 cursor-pointer" onclick="openLightbox('${url}')">
                                                <video src="${url}" class="w-full h-full object-cover"></video>
                                                <div class="absolute inset-0 flex items-center justify-center bg-black/20 text-white text-[8px]"><i class="fa-solid fa-play"></i></div>
                                            </div>`;
                            }
                            return `<img src="${url}" class="w-8 h-8 rounded-lg object-cover border border-slate-200 cursor-pointer" onclick="openLightbox('${url}')">`;
                        }).join('');
                    } catch (e) { return '<span class="text-slate-300 italic text-[10px]">None</span>'; }
                })()}
                </div>
                    </td>
                    <td class="p-6">
                        <span class="px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest 
                            ${b.status === 'confirmed' ? 'bg-emerald-100 text-emerald-700' :
                    b.status === 'completed' ? 'bg-blue-100 text-blue-700' :
                        b.status === 'rejected' ? 'bg-rose-100 text-rose-700' :
                            'bg-amber-100 text-amber-700'}">
                            ${b.status}
                        </span>
                    </td>
                    <td class="p-6 text-right">
                        <div class="flex justify-end gap-2">
                             ${b.status === 'pending' ? `
                                <button onclick="updateStatus('${b.id}', 'confirmed')" class="w-8 h-8 rounded-lg bg-emerald-50 text-emerald-600 hover:bg-emerald-600 hover:text-white transition-all flex items-center justify-center" title="Confirm Booking"><i class="fa-solid fa-check"></i></button>
                                <button onclick="updateStatus('${b.id}', 'rejected')" class="w-8 h-8 rounded-lg bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white transition-all flex items-center justify-center" title="Reject Booking"><i class="fa-solid fa-xmark"></i></button>
                            ` : b.status === 'confirmed' ? `
                                <button onclick="updateStatus('${b.id}', 'completed')" class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition-all flex items-center justify-center" title="Mark as Done"><i class="fa-solid fa-flag-checkered"></i></button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        async function updateStatus(id, newStatus) {
            const { error } = await _supabase.from('bookings').update({ status: newStatus }).eq('id', id);
            if (error) {
                alert("Error updating status: " + error.message);
            } else {
                // Trigger Email Notification via Edge Function (Resend)
                const { error: notifyErr } = await _supabase.functions.invoke('send-booking-notification', {
                    body: {
                        bookingId: id,
                        newStatus: newStatus,
                        type: 'status_update'
                    }
                });

                if (notifyErr) {
                    console.error("Notification Error:", notifyErr);
                    alert("⚠️ Status updated, but email alert failed.");
                } else {
                    console.log("Email Notification Sent via Resend.");
                }

                alert(`✅ Status updated to "${newStatus}".`);
                fetchBookings();
            }
        }

        // --- Session Timeout (AFK Handler) ---
        function initSessionTimeout() {
            let timeout;
            // 1 Hour in milliseconds
            const TIMEOUT_DURATION = 3600000;

            function logoutUser() {
                alert("Session Expired: You have been inactive for 1 hour. Logging out for security.");
                handleLogout();
            }

            function resetTimer() {
                clearTimeout(timeout);
                timeout = setTimeout(logoutUser, TIMEOUT_DURATION);
            }

            // Monitor events
            window.onload = resetTimer;
            document.onmousemove = resetTimer;
            document.onkeypress = resetTimer;
            document.onclick = resetTimer;
            document.onscroll = resetTimer;
        }

        initSessionTimeout();

        async function fetchReviews() {
            const tbody = document.getElementById('review-table-body');
            const { data, error } = await _supabase.from('reviews').select('*, profiles:client_id(full_name)').order('created_at', { ascending: false });

            if (error) {
                console.error("Fetch Reviews Error:", error);
                tbody.innerHTML = `<tr><td colspan="5" class="p-12 text-center text-rose-500 font-bold uppercase tracking-widest text-[10px]">Error loading feedback: ${error.message}</td></tr>`;
                return;
            }

            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-12 text-center text-slate-400 font-bold uppercase tracking-widest text-[10px]">No client feedback found.</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(r => `
                <tr class="hover:bg-slate-50/50 transition-colors">
                    <td class="p-6">
                        <div class="font-bold text-slate-900">${r.profiles?.full_name || 'Client'}</div>
                        <div class="flex gap-1 text-amber-400 mt-1 text-xs">
                            ${'★'.repeat(r.rating)}${'☆'.repeat(5 - r.rating)}
                        </div>
                    </td>
                    <td class="p-6 italic text-slate-600 text-sm">"${r.comment}"</td>
                    <td class="p-6">
                        <div class="flex gap-1">
                            ${(function () {
                    try {
                        const urls = JSON.parse(r.photo_urls || '[]');
                        return urls.map(url => {
                            const isVideo = url.toLowerCase().match(/\.(mp4|mov|webm|ogg|m4v)$/) || url.includes('/video/upload/');
                            if (isVideo) {
                                return `<div class="relative w-8 h-8 rounded-lg overflow-hidden border border-slate-200 cursor-pointer" onclick="openLightbox('${url}')">
                                                        <video src="${url}" class="w-full h-full object-cover"></video>
                                                        <div class="absolute inset-0 flex items-center justify-center bg-black/20 text-white text-[8px]"><i class="fa-solid fa-play"></i></div>
                                                    </div>`;
                            }
                            return `<img src="${url}" class="w-8 h-8 rounded-lg object-cover border border-slate-200 cursor-pointer" onclick="openLightbox('${url}')">`;
                        }).join('');
                    } catch (e) { return '<span class="text-slate-300 italic text-[10px]">None</span>'; }
                })()}
                        </div>
                    </td>
                    <td class="p-6">
                        <span class="px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest ${r.is_public ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-400'}">
                            ${r.is_public ? 'Public' : 'Hidden'}
                        </span>
                    </td>
                    <td class="p-6 text-right">
                        <button onclick="toggleReview('${r.id}', ${r.is_public})" class="px-4 py-2 rounded-xl border-2 ${r.is_public ? 'border-rose-100 text-rose-500' : 'border-blue-100 text-blue-600'} font-black text-[10px] uppercase">
                            ${r.is_public ? 'Hide' : 'Show'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function toggleReview(id, status) {
            await _supabase.from('reviews').update({ is_public: !status }).eq('id', id);
            fetchReviews();
        }

        async function fetchBranches() {
            const tbody = document.getElementById('branch-table-body');
            const { data, error } = await _supabase.from('branches').select('*').order('name');

            if (error) {
                console.error("Fetch Branches Error:", error);
                tbody.innerHTML = `<tr><td colspan="3" class="p-12 text-center text-rose-500 font-bold uppercase tracking-widest text-[10px]">Error loading nodes: ${error.message}</td></tr>`;
                return;
            }

            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="p-12 text-center text-slate-400 font-bold uppercase tracking-widest text-[10px]">No regional nodes defined.</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(b => `
                <tr class="hover:bg-slate-50/50 transition-colors">
                    <td class="p-6 font-bold uppercase tracking-tighter">${b.name}</td>
                    <td class="p-6 text-slate-500">${b.address}</td>
                    <td class="p-6 text-right"><button onclick="deleteResource('branches', '${b.id}')" class="text-rose-500"><i class="fa-solid fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        async function addBranch() {
            const name = document.getElementById('branch-name').value;
            const address = document.getElementById('branch-address').value;
            await _supabase.from('branches').insert([{ name, address }]);
            fetchBranches();
        }

        async function fetchServices() {
            const tbody = document.getElementById('service-table-body');
            const { data, error } = await _supabase.from('services').select('*').order('name');

            if (error) {
                console.error("Fetch Services Error:", error);
                tbody.innerHTML = `<tr><td colspan="4" class="p-12 text-center text-rose-500 font-bold uppercase tracking-widest text-[10px]">Error loading inventory: ${error.message}</td></tr>`;
                return;
            }

            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="p-12 text-center text-slate-400 font-bold uppercase tracking-widest text-[10px]">Service inventory is currently empty.</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(s => `
                <tr class="hover:bg-slate-50/50 transition-colors">
                    <td class="p-6 font-bold uppercase tracking-tighter">${s.name}</td>
                    <td class="p-6 text-slate-500 text-sm italic">${s.description || '-'}</td>
                    <td class="p-6 text-blue-600 font-black text-sm">${s.price_fee || 'N/A'}</td>
                    <td class="p-6 text-right"><button onclick="deleteResource('services', '${s.id}')" class="text-rose-500"><i class="fa-solid fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        async function addService() {
            const name = document.getElementById('service-name').value;
            const desc = document.getElementById('service-desc').value;
            const fee = document.getElementById('service-fee').value;

            await _supabase.from('services').insert([{
                name,
                description: desc,
                price_fee: fee
            }]);

            document.getElementById('service-name').value = '';
            document.getElementById('service-desc').value = '';
            document.getElementById('service-fee').value = '';
            fetchServices();
        }

        async function deleteResource(table, id) {
            const confirmed = await showNiceModal({
                title: "Erase Record",
                message: "Are you sure you want to delete this resource? This cannot be reversed.",
                type: "danger",
                confirmText: "Delete Now",
                cancelText: "Cancel"
            });
            if (!confirmed) return;
            await _supabase.from(table).delete().eq('id', id);
            table === 'branches' ? fetchBranches() : fetchServices();

            showNiceModal({
                title: "Deleted",
                message: "Record removed successfully.",
                type: "success"
            });
        }

        async function fetchAllMedia() {
            const grid = document.getElementById('media-grid');
            grid.innerHTML = '<div class="col-span-full p-20 text-center text-slate-400 font-black uppercase tracking-widest text-xs">Cataloging system media...</div>';

            try {
                const now = new Date();
                const thirtyDaysAgo = new Date(now.setDate(now.getDate() - 30));

                // Fetch from bookings and reviews
                const [{ data: bookings }, { data: reviews }] = await Promise.all([
                    _supabase.from('bookings').select('id, service_type, photo_url, created_at, profiles:client_id(full_name), reviews(rating, is_public)'),
                    _supabase.from('reviews').select('id, comment, rating, photo_urls, created_at, is_public, profiles:client_id(full_name)')
                ]);

                let allMedia = [];
                let purgeableCount = 0;

                if (bookings) {
                    bookings.forEach(b => {
                        let urls = [];
                        try {
                            urls = JSON.parse(b.photo_url || '[]');
                        } catch (e) {
                            if (b.photo_url) urls = [b.photo_url];
                        }
                        const rating = b.reviews && b.reviews[0] ? b.reviews[0].rating : null;
                        const isPublic = b.reviews && b.reviews[0] ? b.reviews[0].is_public : false;
                        const createdAt = new Date(b.created_at);
                        const isOld = createdAt < thirtyDaysAgo;
                        const isPurgeable = !isPublic && isOld;

                        if (isPurgeable && urls.length > 0) purgeableCount += urls.length;

                        urls.forEach(url => {
                            if (url) allMedia.push({
                                url,
                                client: b.profiles?.full_name,
                                type: b.service_type,
                                sourceTable: 'bookings',
                                recordId: b.id,
                                rating,
                                isPublic,
                                isOld,
                                isPurgeable
                            });
                        });
                    });
                }

                if (reviews) {
                    reviews.forEach(r => {
                        let urls = [];
                        try {
                            urls = JSON.parse(r.photo_urls || '[]');
                        } catch (e) {
                            if (r.photo_urls) urls = [r.photo_urls];
                        }
                        const createdAt = new Date(r.created_at);
                        const isOld = createdAt < thirtyDaysAgo;
                        const isPurgeable = !r.is_public && isOld;

                        if (isPurgeable && urls.length > 0) purgeableCount += urls.length;

                        urls.forEach(url => {
                            if (url) allMedia.push({
                                url,
                                client: r.profiles?.full_name,
                                type: 'Review Media',
                                sourceTable: 'reviews',
                                recordId: r.id,
                                rating: r.rating,
                                isPublic: r.is_public,
                                isOld,
                                isPurgeable
                            });
                        });
                    });
                }

                if (allMedia.length === 0) {
                    document.getElementById('media-count').innerText = "0 Assets Discovered";
                    document.getElementById('storage-percent').innerText = "0%";
                    document.getElementById('storage-bar').style.width = "0%";
                    document.getElementById('cleanup-alert').classList.add('hidden');
                    grid.innerHTML = '<div class="col-span-full p-20 text-center text-slate-400 font-black uppercase tracking-widest text-xs">No media files discovered.</div>';
                    return;
                }

                if (purgeableCount > 0) {
                    document.getElementById('cleanup-alert').classList.remove('hidden');
                    document.getElementById('cleanup-count').innerText = `${purgeableCount} Cleanup Candidates`;
                } else {
                    document.getElementById('cleanup-alert').classList.add('hidden');
                }

                const MAX_CAPACITY = 1000; // Database index soft limit
                const usagePercent = Math.min(Math.round((allMedia.length / MAX_CAPACITY) * 100), 100);

                document.getElementById('media-count').innerText = `${allMedia.length} Assets Discovered`;
                document.getElementById('storage-percent').innerText = `${usagePercent}% Capacity Used`;
                document.getElementById('storage-bar').style.width = `${usagePercent}%`;

                // Color change based on usage
                const bar = document.getElementById('storage-bar');
                if (usagePercent > 90) bar.className = "h-full bg-rose-500 transition-all duration-1000";
                else if (usagePercent > 70) bar.className = "h-full bg-amber-500 transition-all duration-1000";
                else bar.className = "h-full bg-blue-600 transition-all duration-1000";

                grid.innerHTML = allMedia.map((m, idx) => {
                    const isVideo = m.url.toLowerCase().match(/\.(mp4|mov|webm|ogg|m4v)$/) || m.url.includes('/video/upload/');
                    return `
                        <div class="group relative aspect-square bg-white rounded-[32px] overflow-hidden border border-slate-100 shadow-sm hover:shadow-xl transition-all duration-500 border-2 hover:border-blue-500/50">
                            <div class="w-full h-full cursor-pointer" onclick="openLightbox('${m.url}')">
                                ${isVideo
                            ? `<video src="${m.url}" class="w-full h-full object-cover"></video><div class="absolute inset-0 flex items-center justify-center bg-black/20 text-white"><i class="fa-solid fa-play"></i></div>`
                            : `<img src="${m.url}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">`}
                            </div>
                            
                            <!-- Status Overlays -->
                            <div class="absolute top-4 left-4 flex flex-col gap-2">
                                <span class="px-2 py-1 bg-white/90 backdrop-blur-md text-slate-900 text-[8px] font-black uppercase tracking-widest rounded-lg shadow-sm">Indexed</span>
                                <span class="px-2 py-1 ${m.isPublic ? 'bg-emerald-500 text-white' : 'bg-amber-500 text-white'} text-[8px] font-black uppercase tracking-widest rounded-lg shadow-sm">
                                    ${m.isPublic ? 'Public' : 'Private'}
                                </span>
                                ${m.isPurgeable ? '<span class="px-2 py-1 bg-rose-500 text-white text-[8px] font-black uppercase tracking-widest rounded-lg shadow-sm">Old Content</span>' : ''}
                            </div>

                            <div class="absolute inset-x-0 bottom-0 p-5 bg-gradient-to-t from-slate-900 via-slate-900/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                <div class="flex items-center justify-between mb-1">
                                    <p class="text-[8px] font-black text-blue-400 uppercase tracking-widest">${m.type}</p>
                                    ${m.rating ? `
                                        <div class="flex gap-0.5 text-amber-400 text-[7px]">
                                            ${'★'.repeat(m.rating)}${'☆'.repeat(5 - m.rating)}
                                        </div>
                                    ` : ''}
                                </div>
                                <p class="text-[10px] font-bold text-white uppercase tracking-tight">${m.client || 'System User'}</p>
                            </div>

                            <button onclick="removeSystemMedia('${m.url}', '${m.sourceTable}', '${m.recordId}')" 
                                class="absolute top-4 right-4 w-10 h-10 rounded-2xl bg-rose-500 hover:bg-rose-600 text-white shadow-lg shadow-rose-500/30 opacity-0 group-hover:opacity-100 transition-all flex items-center justify-center hover:scale-110 active:scale-95"
                                title="Purge Asset">
                                <i class="fa-solid fa-trash-can text-sm"></i>
                            </button>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                grid.innerHTML = `<div class="col-span-full p-20 text-center text-rose-500 font-black uppercase tracking-widest text-xs">Storage Error: ${err.message}</div>`;
            }
        }

        async function removeSystemMedia(url, table, id) {
            const confirmed = await showNiceModal({
                title: "Remove Media",
                message: "Authority requested: Permanently remove this media reference from the system?",
                type: "danger",
                confirmText: "Remove Authority",
                cancelText: "Cancel"
            });
            if (!confirmed) return;

            try {
                const col = table === 'bookings' ? 'photo_url' : 'photo_urls';
                const { data } = await _supabase.from(table).select(col).eq('id', id).single();

                let urls = [];
                try {
                    urls = JSON.parse(data[col] || '[]');
                } catch (e) {
                    if (data[col]) urls = [data[col]];
                }

                urls = urls.filter(u => u !== url);

                const updatePayload = {};
                updatePayload[col] = JSON.stringify(urls);

                const { error } = await _supabase.from(table).update(updatePayload).eq('id', id);
                if (error) throw error;

                showNiceModal({ title: "Authorized", message: "Media reference has been purged.", type: "success" });
                fetchAllMedia();
            } catch (err) {
                showNiceModal({ title: "Error", message: err.message, type: "danger" });
            }
        }

        async function purgeOldMedia() {
            const confirmed = await showNiceModal({
                title: "Bulk Purge Authority",
                message: "This will permanently remove all PRIVATE media references older than 30 days. High storage impact. Confirm?",
                type: "danger",
                confirmText: "Authorize Bulk Purge",
                cancelText: "Cancel"
            });
            if (!confirmed) return;

            try {
                const now = new Date();
                const thirtyDaysAgo = new Date(now.setDate(now.getDate() - 30)).toISOString();

                // 1. Purge from Bookings (Private/Old)
                const { data: bookings } = await _supabase.from('bookings').select('id, photo_url, reviews(is_public)').lt('created_at', thirtyDaysAgo);
                if (bookings) {
                    for (const b of bookings) {
                        const isPublic = b.reviews && b.reviews[0] ? b.reviews[0].is_public : false;
                        if (!isPublic && b.photo_url && b.photo_url !== '[]') {
                            await _supabase.from('bookings').update({ photo_url: '[]' }).eq('id', b.id);
                        }
                    }
                }

                // 2. Purge from Reviews (Private/Old)
                await _supabase.from('reviews').update({ photo_urls: '[]' }).lt('created_at', thirtyDaysAgo).eq('is_public', false);

                showNiceModal({ title: "Authorized", message: "All aged private media references have been purged.", type: "success" });
                fetchAllMedia();
            } catch (err) {
                showNiceModal({ title: "Error", message: err.message, type: "danger" });
            }
        }

        async function handleLogout() {
            const confirmed = await showNiceModal({
                title: "Sign Out",
                message: "Are you sure you want to exit the admin console?",
                type: "warning",
                confirmText: "Sign Out",
                cancelText: "Stay"
            });
            if (!confirmed) return;
            await _supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        // --- Premium Modal System ---
        function showNiceModal({ title, message, type = 'info', confirmText = 'OK', cancelText = null }) {
            return new Promise((resolve) => {
                const modal = document.getElementById('ui-modal');
                const titleEl = document.getElementById('ui-modal-title');
                const msgEl = document.getElementById('ui-modal-msg');
                const iconEl = document.getElementById('modal-icon');
                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');

                titleEl.innerText = title;
                msgEl.innerText = message;
                confirmBtn.innerText = confirmText;

                // Type Styling
                iconEl.className = "w-16 h-16 rounded-3xl flex items-center justify-center text-2xl mx-auto mb-6 ";
                if (type === 'danger') {
                    iconEl.classList.add('bg-rose-50', 'text-rose-500');
                    iconEl.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i>';
                    confirmBtn.className = "flex-1 bg-rose-500 text-white font-black py-4 rounded-2xl hover:bg-rose-600 transition-all uppercase text-[10px] tracking-widest";
                } else if (type === 'success') {
                    iconEl.classList.add('bg-emerald-50', 'text-emerald-500');
                    iconEl.innerHTML = '<i class="fa-solid fa-circle-check"></i>';
                    confirmBtn.className = "flex-1 bg-emerald-500 text-white font-black py-4 rounded-2xl hover:bg-emerald-600 transition-all uppercase text-[10px] tracking-widest";
                } else if (type === 'warning') {
                    iconEl.classList.add('bg-amber-50', 'text-amber-500');
                    iconEl.innerHTML = '<i class="fa-solid fa-circle-exclamation"></i>';
                    confirmBtn.className = "flex-1 bg-amber-500 text-white font-black py-4 rounded-2xl hover:bg-amber-600 transition-all uppercase text-[10px] tracking-widest";
                } else {
                    iconEl.classList.add('bg-blue-50', 'text-blue-500');
                    iconEl.innerHTML = '<i class="fa-solid fa-circle-info"></i>';
                    confirmBtn.className = "flex-1 bg-blue-600 text-white font-black py-4 rounded-2xl hover:bg-blue-700 transition-all uppercase text-[10px] tracking-widest";
                }

                if (cancelText) {
                    cancelBtn.innerText = cancelText;
                    cancelBtn.classList.remove('hidden');
                } else {
                    cancelBtn.classList.add('hidden');
                }

                modal.classList.remove('hidden');

                confirmBtn.onclick = () => { modal.classList.add('hidden'); resolve(true); };
                cancelBtn.onclick = () => { modal.classList.add('hidden'); resolve(false); };
            });
        }

        function openLightbox(src) {
            const modal = document.getElementById('lightbox-modal');
            const container = document.getElementById('lightbox-content');
            const isVideo = src.toLowerCase().match(/\.(mp4|mov|webm|ogg|m4v)$/) || src.includes('/video/upload/');

            container.innerHTML = isVideo
                ? `<video src="${src}" controls autoplay class="max-w-full max-h-full rounded-2xl shadow-2xl"></video>`
                : `<img src="${src}" class="max-w-full max-h-full object-contain rounded-2xl shadow-2xl transition-all">`;

            modal.classList.remove('hidden');
        }

        function closeLightbox() {
            document.getElementById('lightbox-modal').classList.add('hidden');
            document.getElementById('lightbox-content').innerHTML = ''; // Stop video
        }

        // Initial Load
        async function init() {
            try {
                await checkSession();
                switchTab('clients');
            } catch (err) {
                console.error("Initialization Error:", err);
            }
        }
        init();
    </script>
</body>

</html>